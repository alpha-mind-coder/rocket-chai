<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/admin.css" />
</head>
<body>
  <h2>Admin Dashboard</h2>

  <% if (!orders || orders.length === 0) { %>
    <p>No orders yet.</p>
  <% } else { %>
    <table class="order-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Student ID</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Quantity</th>
          <th>Items</th>
          <th>Total Price</th>
          <th>Payment Screenshot</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% orders.forEach((order, index) => { %>
          <tr data-id="<%= order.id %>">
            <td><%= index + 1 %></td>
            <td><%= order.name || "N/A" %></td>
            <td><%= order.student_id || "N/A" %></td>
            <td><%= order.phone || "N/A" %></td>
            <td><%= order.email || "N/A" %></td>
            <td><%= order.quantity || 0 %></td>
            <td>
              <% 
                let items = {};
                try { items = JSON.parse(order.item || "{}"); } catch(e) {}
              %>
              <ul>
                <% for (const [itemId, sizes] of Object.entries(items)) { %>
                  <% for (const [size, details] of Object.entries(sizes)) { %>
                    <li>
                      <strong><%= details.name %></strong> (<%= size %>) — 
                      Qty: <%= details.quantity %>, ₹<%= details.price %>
                    </li>
                  <% } %>
                <% } %>
              </ul>
            </td>
            <td><%= order.total %></td>
            <td>
              <% if (order.screenshot_url) { %>
                <img src="<%= order.screenshot_url %>" alt="Screenshot" class="thumb-img" />
              <% } else { %>
                <em>No screenshot</em>
              <% } %>
            </td>
            <td>
              <button class="delete-btn" data-id="<%= order.id %>">Delete</button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>

<script>
document.querySelectorAll(".delete-btn").forEach(button => {
  button.addEventListener("click", async () => {
    const orderId = button.dataset.id;
    if (!confirm("Are you sure you want to delete this order?")) return;

    button.disabled = true;
    button.innerText = "Deleting...";

    try {
      const response = await fetch(`/admin/delete-order/${orderId}`, { method: "DELETE" });
      if (response.ok) {
        alert("✅ Order deleted");
        const row = button.closest("tr");
        row.parentNode.removeChild(row);
      } else {
        const text = await response.text();
        alert("❌ Error: " + text);
        button.disabled = false;
        button.innerText = "Delete";
      }
    } catch (err) {
      console.error(err);
      alert("❌ Network error");
      button.disabled = false;
      button.innerText = "Delete";
    }
  });
});
</script>
</body>
</html>
